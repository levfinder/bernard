{% extends 'bernard/base.html' %}

{% block head-extra %}

<script src="https://js.api.here.com/v3/3.0/mapsjs-core.js" type="text/javascript" charset="utf-8"></script>
<script src="https://js.api.here.com/v3/3.0/mapsjs-service.js" type="text/javascript" charset="utf-8"></script>
<script src="https://js.api.here.com/v3/3.0/mapsjs-ui.js" type="text/javascript" charset="utf-8"></script>

<link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.0/mapsjs-ui.css" />

{% endblock %}

{% block nav-vehicles %}active{% endblock %}

{% block content %}

<nav aria-label="breadcrumb" class="pt-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item" aria-current="page"><a href="/vehicles">Vehicles</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ vehicle.external_id }}</li>
    </ol>
</nav>

<div class="container pl-3">
    <div class="row">
        <div class="col-md-6">
            <h2 class="h2">
                <span class="text-monospace">{{ vehicle.external_id }}</span>
            </h2>
            <h6 class="h6 subtitle">
                {{ vehicle.vendor.name }}
            </h6>

            <h4 class="h4">Scheduled deliveries</h4>
            <table class="table table-borderless table-sm">
                <thead>
                    <th scope="col">Order</th>
                    <th scope="col">Time</th>
                    <th scope="col">Status</th>
                    <th scope="col"></th>
                </thead>
                {% if scheduled_deliveries %}
                {% for delivery in scheduled_deliveries %}
                <tr>
                    <td>
                        <a href="/orders/{{ delivery.order.id }}">
                            {{ delivery.order.external_id }}</a>
                    </td>
                    <td>{{ delivery.timeslot }}</td>
                    <td>{{ delivery.status }}</td>
                    <td><a class="btn btn-secondary btn-sm" href="/deliveries/{{ delivery.id }}">Update</a>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="3">No schedules found </td>
                </tr>
                {% endif %}
            </table>
            <a class="btn btn-primary" href="/deliveries/new?vehicle={{ vehicle.id }}">Schedule new delivery</a>
        </div>

        <div class="col-md-6">
            <div style="width: 100%; height: 480px" id="map-container"></div>
        </div>
    </div>
</div>

<script>
var platform = new H.service.Platform({
    app_id: '{{ mapping_api_id }}',
    app_code: '{{ mapping_api_code }}',
    useHTTPS: true,
});

var defaultLayers = platform.createDefaultLayers();

var map = new H.Map(
    document.getElementById('map-container'),
    defaultLayers.normal.map,
    {
        zoom: 14,
        center: { lat: 52.5, lng: 13.4 }
    }
);

var ui = H.ui.UI.createDefault(map, defaultLayers);

var location_history = [
{% for location in location_history %}
{lat: {{ location.latitude }}, lng: {{ location.longitude }}},{% endfor %}
];

var linestring = new H.geo.LineString();
location_history.forEach(function(point) {
    linestring.pushPoint(point);
});

last_location = location_history.slice(-1)[0];
map.setCenter(last_location);

marker = new H.map.Marker(last_location);
map.addObject(marker);

var polyline = new H.map.Polyline(linestring, { style: { lineWidth: 8 }});
map.addObject(polyline);
//map.setViewBounds(polyline.getBounds());

</script>

{% endblock %}
